<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Concierge HIS - Health Assistant Workspace (Triage V1.12 - Updated Detail Tabs)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css" rel="stylesheet">
    <style>
        /* --- General Reset and Setup --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%); min-height: 100vh; }
        
        /* --- Header & Sidebar --- */
        .header { background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-bottom: 1px solid #e5e7eb; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .menu-toggle { display: none; background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 0.5rem; transition: background 0.2s; }
        .menu-toggle:hover { background: #f3f4f6; }
        .menu-toggle svg { color: #1f2937; }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .header-title h1 { font-size: 1.5rem; font-weight: bold; color: #1f2937; }
        .header-title p { font-size: 0.875rem; color: #6b7280; }
        .header-right { display: flex; align-items: center; gap: 0.75rem; }
        .user-info { text-align: right; }
        .user-info p { font-size: 0.875rem; font-weight: 600; color: #1f2937; }
        .user-info span { font-size: 0.75rem; color: #6b7280; }
        .user-avatar { width: 40px; height: 40px; background: #3b82f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        .container { max-width: 1280px; margin: 0 auto; padding: 1.5rem; display: flex; gap: 1.5rem; }
        .main-content { flex-grow: 1; }
        .sidebar { position: sticky; top: 7.5rem; left: 0; height: auto; width: 256px; background: white; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: none; z-index: 10; flex-shrink: 0; padding: 1rem; }
        .sidebar-overlay { display: none; }
        .menu-item { display: flex; align-items: center; gap: 0.75rem; width: 100%; padding: 0.75rem 1rem; border-radius: 0.5rem; border: none; background: none; cursor: pointer; transition: all 0.2s; font-size: 1rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem; }
        .menu-item:hover { background: #f3f4f6; }
        .menu-item.active { background: #3b82f6; color: white; }
        
        /* --- Responsive Styles: Tablet/Mobile --- */
        @media (max-width: 1280px) { 
            .menu-toggle { display: block !important; }
            .container { display: block; }
            .sidebar { position: fixed; top: 0; left: -256px; height: 100%; width: 256px; background: white; box-shadow: 4px 0 8px rgba(0, 0, 0, 0.2); transition: left 0.3s ease-in-out; z-index: 1000; padding-top: 5rem; border-radius: 0; }
            .sidebar.open { left: 0; }
            .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999; }
            .main-content { width: 100%; }
            .summary-cards { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
             .summary-cards { grid-template-columns: 1fr; }
             .toolbar { grid-template-columns: repeat(3, 1fr) !important; }
             .toolbar-btn span { display: none; }
        }
        
        /* --- Component Styles --- */
        .summary-cards { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 1rem; 
            margin-bottom: 1.5rem; 
        }
        
        /* --- Summary Card Design --- */
        .summary-card {
            background: linear-gradient(135deg, var(--from-color) 0%, var(--to-color) 100%);
            color: white; 
            padding: 1rem; 
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            transition: transform 0.2s;
            cursor: pointer; 
            border: 2px solid transparent; 
            transform: scale(1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 100px;
        }

        .summary-card:hover { transform: scale(1.02); opacity: 0.9; }
        .summary-card.active { border: 3px solid white; box-shadow: 0 0 0 5px rgba(255, 255, 255, 0.7); transform: scale(1.05); }
        .summary-card-body { text-align: right; margin-bottom: 0.5rem; }
        .summary-card-footer {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding-top: 0.5rem;
             border-top: 1px solid rgba(255, 255, 255, 0.3);
        }

        .summary-card-number { font-size: 2.2rem; font-weight: bold; line-height: 1; }
        .summary-card-label { font-size: 0.875rem; font-weight: 500; opacity: 0.9; text-align: left; }
        .summary-card-footer svg { opacity: 0.8; }
        /* --- End Summary Card Design --- */
		
		


        .card { background: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        .card-title { font-size: 1.25rem; font-weight: bold; color: #1f2937; margin-bottom: 1rem; }
        .hidden { display: none !important; }
        
        .patient-card { background: #ffffff; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1rem; margin-bottom: 0.75rem; transition: all 0.2s; cursor: pointer; }
        .patient-card:hover { box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1); border-color: #3b82f6; transform: translateY(-2px); }
        .patient-card-header { display: flex; justify-content: space-between; align-items: center; }
        .patient-info { display: flex; align-items: center; gap: 1rem; }
        .patient-avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0; }
        .patient-name { font-size: 1rem; font-weight: 600; color: #1f2937; }
        .patient-id { font-size: 0.75rem; color: #6b7280; }
        .status-badge { font-size: 0.75rem; font-weight: 600; padding: 0.3rem 0.6rem; border-radius: 0.5rem; flex-shrink: 0; }
        
        /* --- Patient Detail CSS --- */
        .detail-header { display: flex; align-items: center; gap: 1.5rem; border-bottom: 1px solid #eee; padding-bottom: 1.5rem; margin-bottom: 1.5rem; }
        .detail-avatar { width: 72px; height: 72px; background: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; font-weight: bold; flex-shrink: 0; }
        .detail-info { flex-grow: 1; }
        .detail-info h2 { font-size: 1.75rem; font-weight: bold; color: #1f2937; margin-bottom: 0.25rem; }
        .detail-info p { font-size: 0.875rem; color: #6b7280; }
        .toolbar { display: grid; grid-template-columns: repeat(9, 1fr); gap: 0.5rem; margin-bottom: 2rem; padding: 0.5rem 0; border-bottom: 1px solid #eee; }
        .toolbar-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0.5rem; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #4b5563; border-radius: 0.5rem; font-size: 0.75rem; }
        .toolbar-btn:hover { background: #eff6ff; color: #3b82f6; }
        .toolbar-btn svg { margin-bottom: 0.25rem; }
        .detail-tabs { display: flex; margin-bottom: 1.5rem; overflow-x: auto; border-bottom: 2px solid #e5e7eb; }
        .tab-item { padding: 0.75rem 1rem; border: none; background: none; cursor: pointer; font-size: 1rem; font-weight: 500; color: #6b7280; border-bottom: 2px solid transparent; transition: all 0.3s; white-space: nowrap; }
        .tab-item:hover { color: #1f2937; }
        .tab-item.active { color: #3b82f6; border-bottom: 2px solid #3b82f6; font-weight: 600; }
        .detail-tab-content { padding-top: 1rem; }
        .modern-timeline { position: relative; padding-left: 1rem; }
        .modern-timeline::before { content: ''; position: absolute; top: 0; left: 0.5rem; width: 2px; height: 100%; background: #e5e7eb; z-index: 1; }
        .timeline-item { position: relative; padding: 0 0 2rem 2rem; }
        .timeline-marker { position: absolute; top: 0; left: 0; z-index: 2; }
        .timeline-icon { width: 32px; height: 32px; border-radius: 50%; background: #fff; border: 3px solid #e5e7eb; display: flex; align-items: center; justify-content: center; color: #6b7280; }
        .timeline-item.completed .timeline-icon { background: #10b981; border-color: #10b981; color: white; }
        .timeline-item.active .timeline-icon { background: #3b82f6; border-color: #3b82f6; color: white; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3); }
        .timeline-content h4 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.25rem; color: #1f2937; }
        .timeline-content p { font-size: 0.875rem; color: #4b5563; }
        .timeline-badge { font-size: 0.75rem; font-weight: bold; padding: 0.1rem 0.5rem; border-radius: 0.25rem; background: #f3f4f6; color: #6b7280; margin-bottom: 0.5rem; display: inline-block; }
        
		
		/* --- End Patient Detail CSS --- */
		
		
        
        /* --- Schedule Specific Styles --- */
        .schedule-grid-header { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; font-weight: bold; padding-bottom: 0.5rem; border-bottom: 2px solid #ccc; text-align: center; background: #eef2ff; padding: 0.75rem; border-radius: 0.5rem 0.5rem 0 0; margin-top: -1rem; margin-left: -1rem; margin-right: -1rem; }
        .schedule-grid-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 0.5rem 0.75rem; border-bottom: 1px dashed #eee; font-size: 0.9rem; text-align: center; align-items: center; }
        .schedule-grid-row:last-child { border-bottom: none; }
        
        /* --- Triage/Search Page specific styles --- */
        #page-search input, #page-search select, #page-register input, #page-register select, #page-create-visit input, #page-create-visit select, #page-edit-appointment input, #page-edit-appointment select {
            border: 1px solid #ccc;
            border-radius: 0.5rem;
            padding: 0.75rem;
            font-size: 1rem;
            background: #fff;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            transition: border-color 0.2s;
        }
        #page-search input:focus, #page-search select:focus, #page-register input:focus, #page-register select:focus, #page-create-visit input:focus, #page-create-visit select:focus, #page-edit-appointment input:focus, #page-edit-appointment select:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        /* --- Calendar Specific Styles --- */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; font-weight: bold; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; }
        .calendar-day-name { padding: 0.5rem 0; font-size: 0.875rem; color: #4b5563; background: #f3f4f6; }
        .calendar-day { 
            padding: 0.5rem 0.25rem; 
            border: 1px solid #f3f4f6; 
            cursor: pointer; 
            position: relative; 
            transition: background 0.2s; 
            min-height: 50px; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .calendar-day:hover { background: #eff6ff; }
        .calendar-day.inactive { color: #ccc; cursor: default; background: #fafafa; }
        .calendar-day-date { font-weight: 600; font-size: 0.9rem; line-height: 1; }
        .calendar-appointment-count { 
            display: block; 
            margin-top: 4px; 
            font-size: 0.7rem; 
            font-weight: bold; 
            color: white; 
            background: #10b981; 
            border-radius: 0.5rem; 
            padding: 1px 4px; 
            display: inline-block;
            line-height: 1;
        }
        .calendar-day.today { background: #fffbeb; border: 2px solid #f59e0b; }
        .calendar-day.selected { background: #3b82f6; color: white; border: 2px solid #2563eb; }
        .calendar-day.selected .calendar-appointment-count { background: white; color: #3b82f6; }
        .calendar-day.has-appointment { background: #d1fae5; }
        .calendar-day.has-appointment.today { background: #ffedd5; }

        /* Appointment Search Result Card */
        .appointment-result-card { 
            border: 1px solid #10b981; 
            background: #f0fdf4; 
            padding: 0.75rem; 
            margin-bottom: 0.5rem; 
            border-radius: 0.5rem; 
            font-size: 0.9rem;
            cursor: pointer; /* Added cursor pointer */
            transition: all 0.2s; /* Added transition */
        }
        .appointment-result-card:hover {
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
            background: #e6ffec;
        }
        .appointment-result-card p { margin: 0; line-height: 1.5; }
        .appointment-result-card span { font-weight: 600; }
		
		
        
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <button class="menu-toggle" onclick="toggleSidebar()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
            <div class="header-title">
                <h1>Concierge HIS</h1>
                <p>Health Assistant Workspace</p>
            </div>
        </div>
        <div class="header-right">
            <div class="user-info">
                <p>สมใจ ใจดี</p>
                <span>Concierge</span>
            </div>
            <div class="user-avatar">SJ</div>
        </div>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-content">
                <button class="menu-item active" onclick="showPage('page-home')">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    <span>หน้าหลัก</span>
                </button>
                <button class="menu-item" onclick="showPage('page-my-patients')">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    <span>My Patient (ของฉัน)</span>
                </button>
                <button class="menu-item" onclick="showPage('page-doctor-schedule')">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                    <span>ตารางตรวจแพทย์</span>
                </button>
                <button class="menu-item" onclick="showPage('page-search')">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                    <span>ค้นหา/คัดกรอง</span>
                </button>
                <button class="menu-item" onclick="showPage('page-register')">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
                    <span>Walk-in ใหม่</span>
                </button>
                <button class="menu-item" onclick="showPage('page-appointments')">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><path d="M8 14h.01M12 14h.01M16 14h.01M8 18h.01M12 18h.01M16 18h.01"/></svg>
                    <span>รายการนัด</span>
                </button>
                <button class="menu-item" onclick="showPage('page-patients')">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 5H2v7l6.29 6.29c.94.94 2.48.94 3.42 0l3.58-3.58c.94-.94.94-2.48 0-3.42L9 5z"/><path d="M6 9.01V9"/></svg>
                    <span>ผู้ป่วยทั้งหมด</span>
                </button>
            </div>
        </div>

        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        <div class="main-content">
            <div id="page-home">
                <h2 class="card-title" style="margin-bottom: 1.5rem;">ภาพรวมวันนี้</h2>
                <div class="summary-cards">
                    <div class="summary-card active" data-filter="opd" id="card-opd" style="--from-color: #3b82f6; --to-color: #2563eb;" onclick="filterPatientsByCard('opd', this)">
                        <div class="summary-card-body">
                            <div class="summary-card-number" id="count-opd">0</div>
                        </div>
                        <div class="summary-card-footer">
                            <div class="summary-card-label">ผู้ป่วยนอก (Out Patient)</div>
                            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        </div>
                    </div>
                    <div class="summary-card" data-filter="ipd" id="card-ipd" style="--from-color: #8b5cf6; --to-color: #6d28d9;" onclick="filterPatientsByCard('ipd', this)">
                        <div class="summary-card-body">
                            <div class="summary-card-number" id="count-ipd">0</div>
                        </div>
                        <div class="summary-card-footer">
                            <div class="summary-card-label">ผู้ป่วยใน (IPD Patient)</div>
                            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="15" rx="2" ry="2"/><path d="M2 8h20"/><path d="M12 4v4"/><path d="M8 4v4"/><path d="M16 4v4"/></svg>
                        </div>
                    </div>
                    <div class="summary-card" data-filter="appointments" id="card-appointments" style="--from-color: #10b981; --to-color: #059669;" onclick="filterPatientsByCard('appointments', this)">
                        <div class="summary-card-body">
                            <div class="summary-card-number" id="count-appointments">0</div>
                        </div>
                        <div class="summary-card-footer">
                            <div class="summary-card-label">รายการนัด (Today)</div>
                            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><path d="m9 16 2 2 4-4"/></svg>
                        </div>
                    </div>
                    <div class="summary-card" data-filter="waiting-results" id="card-waiting-results" style="--from-color: #f59e0b; --to-color: #d97706;" onclick="filterPatientsByCard('waiting-results', this)">
                        <div class="summary-card-body">
                            <div class="summary-card-number" id="count-waiting-results">0</div>
                        </div>
                        <div class="summary-card-footer">
                            <div class="summary-card-label">รอผล/รอรับบริการ</div>
                            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 class="card-title" style="margin-bottom: 0;">รายการผู้ป่วยของคุณ</h3>
                        <span class="status-badge" id="filterBadge" style="background: #3b82f6; color: white;">My Patients (Out Patient)</span>
                    </div>
                    <div id="todayAppointmentsList" class="patient-list">
                        </div>
                </div>
            </div>
            
            <div id="page-my-patients" class="hidden">
                <h2 class="card-title">My Patient (ของฉัน)</h2>
                <div class="card">
                    <div id="myPatientsList" class="patient-list">
                         </div>
                </div>
            </div>
            
            <div id="page-doctor-schedule" class="hidden">
                <h2 class="card-title">ตารางตรวจแพทย์</h2>
                <div class="card">
                    <div style="margin-bottom: 1.5rem;">
                        <label for="doctor-select" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151;">เลือกแพทย์:</label>
                        <select id="doctor-select" onchange="loadDoctorSchedule(this.value)" style="width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 0.5rem; font-size: 1rem; background: #fff;">
                            <option value="">-- กรุณาเลือกแพทย์ที่ต้องการค้นหา --</option>
                            </select>
                    </div>
                    
                    <h3 class="card-title" style="border-bottom: 1px solid #eee; padding-bottom: 0.5rem; margin-top: 2rem;">ตารางตรวจ: <span id="schedule-doctor-name" style="color: #3b82f6; font-weight: bold;"></span></h3>

                    <div id="doctor-schedule-calendar" style="min-height: 400px; padding: 1rem; background: #f9fafb; border-radius: 0.75rem; border: 1px solid #e5e7eb;">
                        <p style="text-align: center; color: #6b7280; padding: 2rem;">กรุณาเลือกแพทย์เพื่อแสดงตารางการตรวจ</p>
                    </div>
                </div>
            </div>
            
            <div id="page-search" class="hidden">
                <h2 class="card-title">Search Patient</h2>
                <div class="card">
                    <div style="margin-bottom: 1.5rem;">
                        <label for="triage-search-input" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151;">ค้นหาชื่อ, HN, ID Card หรือเบอร์โทร:</label>
                        <input type="text" id="triage-search-input" placeholder="พิมพ์เพื่อค้นหา..." 
                            onkeyup="filterPatients()" 
                            style="width: 100%;">
                    </div>
                    
                    <h3 class="card-title" style="border-bottom: 1px solid #eee; padding-bottom: 0.5rem; margin-top: 1rem;">ผลการค้นหา</h3>
                    <div id="triagePatientResult" class="patient-list">
                        <p style="text-align: center; color: #6b7280; padding: 1rem;">กรุณาพิมพ์ HN, ชื่อ, ID Card หรือเบอร์โทร เพื่อเริ่มค้นหาข้อมูลผู้ป่วย</p>
                    </div>
                </div>
            </div>
            <div id="page-register" class="hidden">
                <h2 class="card-title">Walk-in ใหม่: ลงทะเบียนผู้ป่วยใหม่</h2>
                <div class="card">
                    <form style="display: grid; gap: 1rem; max-width: 600px;">
                        <p style="color: #6b7280; font-style: italic;">*นี่คือหน้าตัวอย่างสำหรับการลงทะเบียนผู้ป่วยใหม่ (Request 1)</p>
                        <div style="display: grid; gap: 0.5rem;">
                            <label for="reg-name" style="font-weight: 600;">ชื่อ-นามสกุล:</label>
                            <input type="text" id="reg-name" placeholder="ชื่อ-นามสกุล (ภาษาไทย)" required>
                        </div>
                        <div style="display: grid; gap: 0.5rem;">
                            <label for="reg-id" style="font-weight: 600;">เลขบัตรประชาชน/Passport:</label>
                            <input type="text" id="reg-id" placeholder="13 หลัก หรือเลข Passport" required>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div style="display: grid; gap: 0.5rem;">
                                <label for="reg-dob" style="font-weight: 600;">วันเกิด:</label>
                                <input type="date" id="reg-dob" required>
                            </div>
                            <div style="display: grid; gap: 0.5rem;">
                                <label for="reg-gender" style="font-weight: 600;">เพศ:</label>
                                <select id="reg-gender" required>
                                    <option value="">เลือกเพศ</option>
                                    <option value="M">ชาย</option>
                                    <option value="F">หญิง</option>
                                </select>
                            </div>
                        </div>
                        <button type="button" onclick="alert('จำลอง: บันทึกผู้ป่วยใหม่และเปิด Visit เรียบร้อย')" 
                                style="padding: 1rem; background: #10b981; color: white; border: none; border-radius: 0.5rem; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 1rem;">
                            บันทึกและเปิด Visit ใหม่
                        </button>
                    </form>
                </div>
            </div>
            <div id="page-appointments" class="hidden">
                <h2 class="card-title">รายการนัด (Appointment Management)</h2>
                <div class="card">
                    <div style="display: flex; gap: 1.5rem; flex-wrap: wrap;">
                        <div style="flex: 1 1 350px;">
                            <h3 class="card-title" style="border-bottom: 1px solid #eee; padding-bottom: 0.5rem;">ภาพรวมนัดรายเดือน</h3>
                            <div id="appointmentCalendar" style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.75rem; background: #f9fafb;">
                                </div>
                            <div id="dailyAppointmentList" style="margin-top: 1.5rem;">
                                <h4 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">รายการนัดประจำวันที่ <span id="selectedDateText" style="color: #3b82f6;">วันนี้</span></h4>
                                <div id="dailyAppointmentsContainer" class="patient-list">
                                    </div>
                            </div>
                        </div>

                        <div style="flex: 1 1 350px;">
                            <h3 class="card-title" style="border-bottom: 1px solid #eee; padding-bottom: 0.5rem;">ค้นหานัดผู้ป่วย</h3>
                            <div style="margin-bottom: 1rem;">
                                <input type="text" id="appointment-search-input" placeholder="ค้นหาชื่อ, HN, ID Card หรือเบอร์โทร..." 
                                       onkeyup="filterAppointmentsByPatient()" 
                                       style="width: 100%; border: 1px solid #ccc; border-radius: 0.5rem; padding: 0.75rem;">
                            </div>
                            
                            <h4 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">ผลการค้นหา</h4>
                            <div id="appointmentSearchResult" class="patient-list">
                                <p style="text-align: center; color: #6b7280; padding: 1rem;">พิมพ์เพื่อค้นหารายการนัดของผู้ป่วย</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="page-patients" class="hidden"><h2 class="card-title">ผู้ป่วยทั้งหมด</h2><div class="card">Coming Soon...</div></div>
            
            <div id="page-create-visit" class="hidden">
                <button class="menu-item" style="width: auto;" onclick="showPage('page-search')">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg> กลับหน้าค้นหา
                </button>
                <h2 class="card-title">สร้าง Visit ใหม่สำหรับผู้ป่วยเก่า</h2>
                <div class="card">
                    <div id="createVisitContent">
                        <p style="text-align: center; color: #6b7280; padding: 2rem;">ข้อมูลผู้ป่วยจะแสดงที่นี่เพื่อเปิด Visit ใหม่</p>
                    </div>
                </div>
            </div>
            <div id="page-edit-appointment" class="hidden">
                <div id="editAppointmentContent">
                    <p style="text-align: center; color: #6b7280; padding: 2rem;">หน้าจอสำหรับแก้ไขรายการนัด</p>
                </div>
            </div>
            <div id="page-patient-detail" class="hidden">
                <button class="menu-item" style="width: auto;" onclick="showPage('page-home')">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg> กลับหน้าหลัก
                </button>

                <div class="card">
                    
                    <div class="detail-header">
                        <div class="detail-avatar" id="detailAvatar">A</div>
                        <div class="detail-info">
                            <h2 id="detailName">ชื่อผู้ป่วย</h2>
                            <p id="detailHN">HN: - | VN: -</p>
                            <p id="detailConcierge">Concierge: -</p>
                        </div>
                        <span class="status-badge" id="detailStatus" style="font-size: 1rem; padding: 0.5rem 1rem;">สถานะ</span>
                    </div>
                    <div style="display: flex; justify-content: space-around; margin-top: 1rem; margin-bottom: 1rem; font-size: 0.875rem; color: #374151; padding: 0.5rem; background: #f9fafb; border-radius: 0.5rem;">
                        <span>**อายุ:** <span id="detailAge"></span></span>
                        <span>**เพศ:** <span id="detailGender"></span></span>
                        <span>**วันเกิด:** <span id="detailDOB"></span></span>
                    </div>

                    <div class="toolbar">
                        <button class="toolbar-btn" onclick="openPatientRegistration(currentPatientData)" title="ลงทะเบียน/เปิด Visit"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M16 11h6"/><path d="M19 8v6"/></svg><span>Alive</span></button>
                        <button class="toolbar-btn" onclick="openScreening(currentPatientData)" title="คัดกรอง (Screening)"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 3v18"/><path d="M9 8h6"/><path d="M9 13h6"/><path d="M9 18h6"/></svg><span>Screening</span></button>
                        <button class="toolbar-btn" onclick="openAssessment(currentPatientData)" title="ประเมิน (Assessment)"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg><span>Assessment</span></button>
                        <button class="toolbar-btn" onclick="assignDoctor(currentPatientData)" title="กำหนดแพทย์"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg><span>Assign แพทย์</span></button>
                        <button class="toolbar-btn" onclick="createAppointment(currentPatientData)" title="ทำนัด"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="7" y1="14" x2="17" y2="14"/></svg><span>ทำนัด</span></button>
                        <button class="toolbar-btn" onclick="openHomeMed(currentPatientData)" title="HomeMed/มาจาก บ้าน"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-1"/><path d="M10 10V6a2 2 0 0 1 2-2h4V3"/><path d="M3 8v10a2 2 0 0 0 2 2h14"/><path d="M22 10v6a2 2 0 0 1-2 2h-4"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="16" y1="18" x2="16" y2="22"/></svg><span>Note</span></button>
                        <button class="toolbar-btn" onclick="openBilling(currentPatientData)" title="แจ้งค่าใช้จ่าย/ชำระเงิน"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg><span>Billing</span></button>
                        <button class="toolbar-btn" onclick="pickUpMedicine(currentPatientData)" title="รับยาแทนคนไข้"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 21a9 9 0 0 0 9-9c0-6-4-9-9-9s-9 3-9 9a9 9 0 0 0 9 9z"/><path d="M10 12h4"/><path d="M12 10v4"/></svg><span>รับยาแทน</span></button>
                        <button class="toolbar-btn" onclick="openOther(currentPatientData)" title="จัดการอื่นๆ"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg><span>จัดการอื่นๆ</span></button>
                    </div>

                    <div class="detail-tabs">
                        <button class="tab-item active" onclick="showDetailTab('timeline-tab', this)">Timeline</button>
                        <button class="tab-item" onclick="showDetailTab('services-tab', this)">Services/Investigate</button>
                        <button class="tab-item" onclick="showDetailTab('medication-tab', this)">Medication/RX</button>
                        <button class="tab-item" onclick="showDetailTab('history-tab', this)">ประวัติเก่า</button>
                        <button class="tab-item" onclick="showDetailTab('billing-tab', this)">บัญชี/ค่าใช้จ่าย</button>
                    </div>
                    
                    <div id="timeline-tab" class="detail-tab-content">
                        <h3 class="card-title">Patient Journey (Timeline)</h3>
                        <div class="modern-timeline" id="patientTimeline">
                            </div>
                    </div>
                    
                    <div id="services-tab" class="detail-tab-content hidden">
    <h3 class="card-title">Services/Investigate</h3>

    <div style="display:grid; grid-template-columns:2fr 1fr 1fr 2fr; gap:0.5rem;
        font-weight:bold; padding:0.75rem 0.5rem;
        border-bottom:2px solid #ccc; background:#f3f4f6;
        border-radius:0.5rem 0.5rem 0 0;">

        <div>รายการตรวจ</div>
        <div style="text-align:center;">วันที่</div>
        <div style="text-align:center;">สถานะ</div>
        <div>Note</div>
    </div>

    <div style="font-size:0.9rem;">
        <div style="display:grid; grid-template-columns:2fr 1fr 1fr 2fr; gap:0.5rem;
            padding:0.75rem 0.5rem; border-bottom:1px solid #eee; align-items:center;">
            <div style="font-weight:600;">CBC (Complete Blood Count)</div>
            <div style="text-align:center;">2025-10-28</div>
            <div style="text-align:center;">
                <span style="background:#f59e0b; color:white; padding:0.3rem 0.6rem; border-radius:0.5rem;">
                    New Order
                </span>
            </div>
            <div style="color:#4b5563;">-</div>
        </div>

        <div style="display:grid; grid-template-columns:2fr 1fr 1fr 2fr; gap:0.5rem;
            padding:0.75rem 0.5rem; border-bottom:1px solid #eee; align-items:center;">
            <div style="font-weight:600;">X-Ray Chest</div>
            <div style="text-align:center;">2025-10-28</div>
            <div style="text-align:center;">
                <span style="background:#10b981; color:white; padding:0.3rem 0.6rem; border-radius:0.5rem;">
                    New Order
                </span>
            </div>
            <div style="color:#4b5563;">เสร็จแล้ว พา Pt. ไปทานข้าวก่อน แล้วกลับมาพบ แพทย์ 13.30 </div>
        </div>
    </div>
</div>


                    <div id="medication-tab" class="detail-tab-content hidden">
                        </div>
                    
                    <div id="history-tab" class="detail-tab-content hidden">
                        </div>

                    <div id="billing-tab" class="detail-tab-content hidden">
                        </div>

                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global Data Store
        let currentPatientData = null;
        
        // Date helpers for mock data
        const today = new Date();
        const todayDate = today.toISOString().split('T')[0];
        const futureDate1 = new Date(today);
        futureDate1.setDate(today.getDate() + 7);
        const futureDate2 = new Date(today);
        futureDate2.setDate(today.getDate() + 15);
        
        // Current calendar view state
        let currentCalendarYear = today.getFullYear();
        let currentCalendarMonth = today.getMonth(); // 0 = Jan, 11 = Dec

        // --- 1. MOCK DATA (Updated with new tabs data) ---
        const patients = [
            // --- MY OPD PATIENTS (10 entries for OPD Card List) ---
            
			{ hn: 'HN0001', name: '👑 สมชาย ใจดี  ', vn: 'VN001-2567', age: 45, gender: 'M ', dob: '1980-05-15', idCard: '1101010101010', tel: '0811111111', status: 'waiting-lab', concierge: 'สมใจ ใจดี', type: 'opd', hasTodayVisit: true, doctor: 'นพ. วิทยา เก่งกาจ' }, 
            { hn: 'HN0002', name: 'สมหญิง รักสุขภาพ', vn: 'VN002-2567', age: 28, gender: 'F', dob: '1997-01-20', idCard: '2202020202020', tel: '0822222222', status: 'in-treatment', concierge: 'สมใจ ใจดี', type: 'opd', hasTodayVisit: true, doctor: 'พญ. สุดา น่ารัก' }, 
            { hn: 'HN0005', name: '👑 ชูใจ ใจเย็น', vn: 'VN005-2567', age: 12, gender: 'F', dob: '2013-08-10', idCard: '5505050505050', tel: '0855555555', status: 'waiting-doctor', concierge: 'สมใจ ใจดี', type: 'opd', hasTodayVisit: true, doctor: 'นพ. ทรงพล มือแม่น' }, 
            { hn: 'HN0006', name: 'ปรีชา ว่องไว', vn: 'VN006-2567', age: 55, gender: 'M', dob: '1970-02-14', idCard: '6606060606060', tel: '0866666666', status: 'waiting-service', concierge: 'สมใจ ใจดี', type: 'opd', hasTodayVisit: true, doctor: 'นพ. วิทยา เก่งกาจ' }, 
            { hn: 'HN0007', name: 'วารี มีน้ำใจ', vn: 'VN007-2567', age: 39, gender: 'F', dob: '1986-07-21', idCard: '7707070707070', tel: '0877777777', status: 'in-treatment', concierge: 'สมใจ ใจดี', type: 'opd', hasTodayVisit: true, doctor: 'พญ. สุดา น่ารัก' }, 
            { hn: 'HN0008', name: 'ศักดิ์ชัย ชัยชนะ', vn: 'VN008-2567', age: 70, gender: 'M', dob: '1955-01-01', idCard: '8808080808080', tel: '0888888888', status: 'waiting-medication', concierge: 'สมใจ ใจดี', type: 'opd', hasTodayVisit: true, doctor: 'นพ. ทรงพล มือแม่น' }, 
            { hn: 'HN0009', name: 'อรุณา สุขสันต์', vn: 'VN009-2567', age: 24, gender: 'F', dob: '2001-10-30', idCard: '9909090909090', tel: '0899999999', status: 'pending-screening', concierge: 'สมใจ ใจดี', type: 'opd', hasTodayVisit: true, doctor: 'นพ. วิทยา เก่งกาจ' },
            { hn: 'HN0010', name: 'ทวีชัย มั่งคั่ง', vn: 'VN010-2567', age: 48, gender: 'M', dob: '1977-04-12', idCard: '1010101010101', tel: '0801010101', status: 'finished', concierge: 'สมใจ ใจดี', type: 'opd', hasTodayVisit: true, doctor: 'พญ. สุดา น่ารัก' },
            { hn: 'HN0011', name: 'กานดา อ่อนหวาน', vn: 'VN011-2567', age: 19, gender: 'F', dob: '2006-09-05', idCard: '1111111111111', tel: '0811111112', status: 'in-treatment', concierge: 'สมใจ ใจดี', type: 'opd', hasTodayVisit: true, doctor: 'นพ. ทรงพล มือแม่น' },
            { hn: 'HN0012', name: 'พิชิต ชัยภูมิ', vn: 'VN012-2567', age: 62, gender: 'M', dob: '1963-03-03', idCard: '1212121212121', tel: '0821212121', status: 'waiting-billing', concierge: 'สมใจ ใจดี', type: 'opd', hasTodayVisit: true, doctor: 'นพ. วิทยา เก่งกาจ' }, 

            // --- MY IPD PATIENTS (5 entries for IPD Card List) ---
            { hn: 'HN0003', name: 'มานะ มามาก', vn: 'VN003-2567', age: 60, gender: 'M', dob: '1965-11-01', idCard: '3303030303030', tel: '0833333333', status: 'ipd-admitted', concierge: 'สมใจ ใจดี', type: 'ipd', hasTodayVisit: true, doctor: 'นพ. ทรงพล มือแม่น' },
            { hn: 'HN0013', name: 'ดารณี เด่นดวง', vn: 'VN013-2567', age: 50, gender: 'F', dob: '1975-12-25', idCard: '1313131313131', tel: '0831313131', status: 'ipd-admitted', concierge: 'สมใจ ใจดี', type: 'ipd', hasTodayVisit: true, doctor: 'พญ. สุดา น่ารัก' },
            { hn: 'HN0014', name: 'วีระ กล้าหาญ', vn: 'VN014-2567', age: 44, gender: 'M', dob: '1981-06-06', idCard: '1414141414141', tel: '0841414141', status: 'ipd-admitted', concierge: 'นพ. วิทยา เก่งกาจ', type: 'ipd', hasTodayVisit: true, doctor: 'นพ. วิทยา เก่งกาจ' },
            { hn: 'HN0015', name: 'รุ่งอรุณ แสงทอง', vn: 'VN015-2567', age: 31, gender: 'F', dob: '1994-01-01', idCard: '1515151515151', tel: '0851515151', status: 'ipd-admitted', concierge: 'นพ. ทรงพล มือแม่น', type: 'ipd', hasTodayVisit: true, doctor: 'นพ. ทรงพล มือแม่น' },
            { hn: 'HN0016', name: 'สุพจน์ พึ่งพา', vn: 'VN016-2567', age: 77, gender: 'M', dob: '1948-02-02', idCard: '1616161616161', tel: '0861616161', status: 'ipd-admitted', concierge: 'พญ. สุดา น่ารัก', type: 'ipd', hasTodayVisit: true, doctor: 'พญ. สุดา น่ารัก' },

            // --- OTHER PATIENTS (5 entries for Dashboard Counts and Triage testing) ---
            { hn: 'HN0017', name: 'ฟ้าใส ใจเย็น', vn: 'VN017-2567', age: 22, gender: 'F', dob: '2003-11-11', idCard: '1717171717171', tel: '0871717171', status: 'pending-screening', concierge: 'อื่น ๆ', type: 'opd', hasTodayVisit: true, doctor: 'นพ. วิทยา เก่งกาจ' }, 
            { hn: 'HN0018', name: 'ธงชัย มีชัย', vn: null, age: 50, gender: 'M', dob: '1975-08-08', idCard: '1818181818181', tel: '0881818181', status: 'no-visit', concierge: 'อื่น ๆ', type: 'opd', hasTodayVisit: false, doctor: null }, 
            { hn: 'HN0019', name: 'เมษา อากาศดี', vn: 'VN019-2567', age: 15, gender: 'F', dob: '2010-04-01', idCard: '1919191919191', tel: '0891919191', status: 'pending-screening', concierge: 'อื่น ๆ', type: 'opd', hasTodayVisit: true, doctor: 'พญ. สุดา น่ารัก' }, 
            { hn: 'HN0020', name: 'พายุ ฝนฟ้า', vn: 'VN020-2567', age: 65, gender: 'M', dob: '1960-05-05', idCard: '2020202020202', tel: '0802020202', status: 'ipd-admitted', concierge: 'อื่น ๆ', type: 'ipd', hasTodayVisit: true, doctor: 'นพ. ทรงพล มือแม่น' }, 
            { hn: 'HN0004', name: 'นารี มีสุข', vn: null, age: 33, gender: 'F', dob: '1992-03-25', idCard: '4404040404040', tel: '0844444444', status: 'no-visit', concierge: null, type: 'opd', hasTodayVisit: false, doctor: null }, 
            
            // --- PATIENT FOR TESTING "NOT FOUND" SCENARIO
            { hn: 'HN9999', name: 'ผู้ป่วยทดสอบระบบ', vn: null, age: 30, gender: 'F', dob: '1995-01-01', idCard: '9999999999999', tel: '0999999999', status: 'no-visit', concierge: null, type: 'opd', hasTodayVisit: false, doctor: null }, 
        ];
        
        // --- APPOINTMENT MOCK DATA (Unchanged) ---
        const allAppointments = [
            // Today's appointments (for reference in the calendar)
            { hn: 'HN0001', name: 'สมชาย ใจดี', date: todayDate, time: '10:00', doctor: 'นพ. วิทยา เก่งกาจ', speciality: 'อายุรกรรม', status: 'Active' },
            { hn: 'HN0002', name: 'สมหญิง รักสุขภาพ', date: todayDate, time: '11:00', doctor: 'พญ. สุดา น่ารัก', speciality: 'กุมารเวชกรรม', status: 'Active' },
            { hn: 'HN0005', name: '👑ชูใจ ใจเย็น', date: todayDate, time: '14:00', doctor: 'นพ. ทรงพล มือแม่น', speciality: 'ศัลยกรรมกระดูก', status: 'Active' },
            { hn: 'HN0017', name: 'ฟ้าใส ใจเย็น', date: todayDate, time: '16:00', doctor: 'นพ. วิทยา เก่งกาจ', speciality: 'อายุรกรรม', status: 'Active' },
            
            // Future appointments (for search and calendar view)
            { hn: 'HN0001', name: 'สมชาย ใจดี', date: futureDate1.toISOString().split('T')[0], time: '09:00', doctor: 'นพ. วิทยา เก่งกาจ', speciality: 'อายุรกรรม', status: 'Scheduled' },
            { hn: 'HN0008', name: 'ศักดิ์ชัย ชัยชนะ', date: futureDate1.toISOString().split('T')[0], time: '13:00', doctor: 'นพ. ทรงพล มือแม่น', speciality: 'ศัลยกรรมกระดูก', status: 'Scheduled' },
            { hn: 'HN0002', name: 'สมหญิง รักสุขภาพ', date: futureDate2.toISOString().split('T')[0], time: '15:30', doctor: 'พญ. สุดา น่ารัก', speciality: 'กุมารเวชกรรม', status: 'Scheduled' },
            { hn: 'HN0018', name: 'ธงชัย มีชัย', date: futureDate2.toISOString().split('T')[0], time: '10:00', doctor: 'พญ. สุดา น่ารัก', speciality: 'กุมารเวชกรรม', status: 'Scheduled' },
            { hn: 'HN0018', name: 'ธงชัย มีชัย', date: futureDate2.toISOString().split('T')[0], time: '11:00', doctor: 'พญ. สุดา น่ารัก', speciality: 'กุมารเวชกรรม', status: 'Scheduled' }, 
        ];

        const doctors = [
            { id: 'D001', name: 'นพ. วิทยา เก่งกาจ', speciality: 'อายุรกรรม' },
            { id: 'D002', name: 'พญ. สุดา น่ารัก', speciality: 'กุมารเวชกรรม' },
            { id: 'D003', name: 'นพ. ทรงพล มือแม่น', speciality: 'ศัลยกรรมกระดูก' },
        ];

        const doctorSchedules = {
            'D001': [
                { day: 'Mon', time: '09:00-12:00', room: 'OPD 1', status: 'Open' },
                { day: 'Wed', time: '13:00-16:00', room: 'OPD 2', status: 'Open' },
                { day: 'Fri', time: '09:00-12:00', room: 'OPD 1', status: 'Closed' }
            ],
            'D002': [
                { day: 'Tue', time: '10:00-14:00', room: 'Pediatric 3', status: 'Open' },
                { day: 'Thu', time: '08:00-12:00', room: 'Pediatric 3', status: 'Open' }
            ],
            'D003': [
                { day: 'Mon', time: '14:00-17:00', room: 'Ortho 5', status: 'Open' },
                { day: 'Tue', time: '09:00-12:00', room: 'Ortho 5', status: 'Open' }
            ]
        };

        // --- NEW MOCK DATA for Patient Detail Tabs (Request 3) ---
        const patientMedication = {
            'HN0001': [
                { name: 'Paracetamol 500 mg', qty: 30, unit: 'เม็ด', instruction: 'รับประทานครั้งละ 1 เม็ด เมื่อมีอาการปวดหรือเป็นไข้', status: 'จัดยาแล้ว', dispensingDate: '2025-10-27 12:00' },
                { name: 'Amoxicillin 500 mg', qty: 15, unit: 'แคปซูล', instruction: 'รับประทานครั้งละ 1 แคปซูล หลังอาหาร เช้า-เย็น 7 วัน', status: 'รอจัดยา', dispensingDate: null },
            ],
            'HN0002': [
                { name: 'Cough Syrup', qty: 1, unit: 'ขวด', instruction: 'รับประทานครั้งละ 5 ซีซี วันละ 3 ครั้ง', status: 'จัดยาแล้ว', dispensingDate: '2025-10-27 11:30' },
            ]
        };

        const patientVisits = {
            'HN0001': [
                { vn: 'VN001-2567', date: '2025-10-27', doctor: 'นพ. วิทยา เก่งกาจ', reason: 'ปวดหัว/มีไข้', status: 'Finished' },
                { vn: 'VN123-2566', date: '2024-12-15', doctor: 'พญ. สุดา น่ารัก', reason: 'ตรวจสุขภาพประจำปี', status: 'Finished' },
                { vn: 'VN456-2566', date: '2024-05-20', doctor: 'นพ. ทรงพล มือแม่น', reason: 'อุบัติเหตุข้อเท้าพลิก', status: 'Finished' },
            ],
            'HN0002': [
                { vn: 'VN002-2567', date: '2025-10-27', doctor: 'พญ. สุดา น่ารัก', reason: 'ไอ/เจ็บคอ', status: 'In Progress' },
                { vn: 'VN789-2565', date: '2023-07-01', doctor: 'นพ. วิทยา เก่งกาจ', reason: 'ฉีดวัคซีนไข้หวัดใหญ่', status: 'Finished' },
            ]
        };
		
		

        const patientBilling = {
            'HN0001': [
                { date: '2025-10-27', description: 'ค่าบริการ OPD ', amount: 3500.00, status: 'รอชำระ', type: 'Current' },
                { date: '2025-10-27', description: 'ค่ายา', amount: 5000.00, status: 'รอชำระ', type: 'Past' },
                { date: '2025-10-27', description: 'ค่าผ่าตัด/กายภาพ ', amount: 30000.00, status: 'รอชำระ', type: 'Past' },
            ],
            'HN0002': [
                { date: '2025-10-27', description: 'ค่าบริการ OPD ', amount: 1000.00, status: 'รอชำระ', type: 'Current' },
            ]
        };
		
		// Mockup Data - Services/Lab
const patientServices = {
    "HN0001": [
        {
            name: "CBC (Complete Blood Count)",
            status: "รอผล",
            date: "2025-10-28",
            result: "-"
        },
        {
            name: "X-Ray Chest",
            status: "ออกผลแล้ว",
            date: "2025-10-28",
            result: "ไม่มีความผิดปกติ"
        }
    ]
};

				
        // --- End New Mock Data ---

        // --- 2. HELPER FUNCTIONS (Unchanged) ---
        
        function isWaitingStatus(status) {
            return status.startsWith('waiting-');
        }

        function getStatusColor(status) {
            switch (status) {
                case 'pending-screening': return 'background: #ffc107; color: #343a40;'; // Yellow
                case 'in-treatment': return 'background: #007bff; color: white;'; // Blue
                case 'waiting-doctor': return 'background: #ff7f00; color: white;'; // Orange
                case 'waiting-medication': return 'background: #8b5cf6; color: white;'; // Purple
                case 'waiting-billing': return 'background: #dc3545; color: white;'; // Red
                case 'waiting-lab': return 'background: #17a2b8; color: white;'; // Cyan
                case 'waiting-service': return 'background: #34d399; color: white;'; // Green-ish
                case 'ipd-admitted': return 'background: #dc3545; color: white;'; 
                case 'finished': return 'background: #28a745; color: white;'; 
                case 'no-visit': return 'background: #6c757d; color: white;'; 
                default: return 'background: #6c757d; color: white;'; 
            }
        }
        
        function getStatusText(status) {
             switch (status) {
                case 'pending-screening': return 'รอคัดกรอง';
                case 'in-treatment': return 'พบแพทย์/รับยา';
                case 'waiting-doctor': return 'รอพบแพทย์';
                case 'waiting-medication': return 'รอจ่ายยา';
                case 'waiting-billing': return 'รอจ่ายเงิน';
                case 'waiting-lab': return 'รอผล Lab/X-Ray';
                case 'waiting-service': return 'รอรับบริการอื่นๆ';
                case 'ipd-admitted': return 'ผู้ป่วยใน (IPD)';
                case 'finished': return 'เสร็จสิ้น';
                case 'no-visit': return 'ไม่มี Visit วันนี้'; 
                default: return 'ไม่ระบุสถานะ';
            }
        }

        function createPatientCard(patient, mode = 'detail') {
            const statusInfo = getStatusColor(patient.status);
            const doctorName = patient.doctor || 'ไม่ระบุ';
            const conciergeName = patient.concierge || 'ไม่ระบุ';
            
            let clickAction;
            if (mode === 'triage') {
                 // Triage: Click on card only works if they have a visit, otherwise the button is used
                 clickAction = patient.hasTodayVisit ? `showPatientDetail('${patient.hn}')` : 'void(0)';
            } else {
                 clickAction = `showPatientDetail('${patient.hn}')`;
            }

            return `
                <div class="patient-card" onclick="${clickAction}" style="${patient.hasTodayVisit ? '' : 'background: #f1f5f9; cursor: default;'}">
                    <div class="patient-card-header">
                        <div class="patient-info">
                            <div class="patient-avatar" style="background: ${patient.gender === 'M' ? '#3b82f6' : '#ec4899'};">${patient.name.charAt(0)}</div>
                            <div>
                                <div class="patient-name">${patient.name} (${patient.age} ปี)</div>
                                <div class="patient-id">HN: ${patient.hn} | VN: ${patient.vn || '-'}</div>
                                <div style="font-size: 0.75rem; color: #4b5563; margin-top: 0.25rem;">
                                    <span style="font-weight: 600;">แพทย์:</span> ${doctorName} | 
                                    <span style="font-weight: 600;">Concierge:</span> ${conciergeName}
                                </div>
                            </div>
                        </div>
                        <span class="status-badge" style="${statusInfo}">${getStatusText(patient.status)}</span>
                    </div>
                </div>
            `;
        }
        
        // --- 3. PAGE LOGIC (Unchanged) ---

        function showPage(pageId) {
            const pages = document.querySelectorAll('.main-content > div');
            pages.forEach(page => page.classList.add('hidden'));
            
            const selectedPage = document.getElementById(pageId);
            if (selectedPage) {
                selectedPage.classList.remove('hidden');
            }

            // Update active menu item
            if (pageId.startsWith('page-')) {
                document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
                const activeMenuItem = document.querySelector(`.menu-item[onclick*="${pageId}"]`);
                if (activeMenuItem) {
                    activeMenuItem.classList.add('active');
                }
            }
            
            // Close sidebar on mobile after clicking a menu item
            if (window.innerWidth <= 1280) {
                 toggleSidebar(true);
            }
            
            // Special initialization for pages
            if (pageId === 'page-home') {
                filterPatientsByCard('opd', document.getElementById('card-opd')); 
            } else if (pageId === 'page-my-patients') {
                const allMyPatients = patients.filter(p => p.concierge === 'สมใจ ใจดี' && p.hasTodayVisit);
                document.getElementById('myPatientsList').innerHTML = allMyPatients.length > 0
                    ? allMyPatients.map(p => createPatientCard(p, 'detail')).join('')
                    : '<p style="text-align: center; color: #6b7280; padding: 1rem;">ไม่พบรายการผู้ป่วยในความดูแลของคุณวันนี้</p>';
            } else if (pageId === 'page-doctor-schedule') {
                populateDoctorSelect();
            } else if (pageId === 'page-appointments') {
                // Initialize Appointments Page (Calendar and Daily List)
                initializeAppointmentsPage();
            } else if (pageId === 'page-search') {
                // Clear search result when entering Triage page
                document.getElementById('triagePatientResult').innerHTML = '<p style="text-align: center; color: #6b7280; padding: 1rem;">กรุณาพิมพ์ HN, ชื่อ, ID Card หรือเบอร์โทร เพื่อเริ่มค้นหาข้อมูลผู้ป่วย</p>';
                document.getElementById('triage-search-input').value = '';
            }
        }

        /**
         * Filters the patient list displayed below the cards based on the clicked card (filterType).
         */
        function filterPatientsByCard(filterType, element) {
            const listContainer = document.getElementById('todayAppointmentsList');
            const myActivePatients = patients.filter(p => p.concierge === 'สมใจ ใจดี' && p.hasTodayVisit);
            
            let filtered;
            let labelText;

            if (filterType === 'opd') {
                filtered = myActivePatients.filter(p => p.type === 'opd');
                labelText = 'My Patients (Out Patient)';
            } else if (filterType === 'ipd') {
                filtered = myActivePatients.filter(p => p.type === 'ipd');
                labelText = 'My Patients (IPD Patient)';
            } else if (filterType === 'appointments') {
                filtered = myActivePatients; 
                labelText = 'My Patients (Appointments/All Active)';
            } else if (filterType === 'waiting-results') {
                filtered = myActivePatients.filter(p => isWaitingStatus(p.status));
                labelText = 'My Patients (รอผล/รอรับบริการ)';
            } else {
                 filtered = myActivePatients;
                 labelText = 'My Patients (All Active)';
            }
            
            listContainer.innerHTML = filtered.length > 0
                ? filtered.map(p => createPatientCard(p, 'detail')).join('')
                : '<p style="text-align: center; color: #6b7280; padding: 1rem;">ไม่พบรายการผู้ป่วยในหมวดหมู่นี้ในความดูแลของคุณ</p>';
                
            document.getElementById('filterBadge').textContent = labelText;

            document.querySelectorAll('.summary-card').forEach(card => card.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            }
        }

        function updateDashboardCounts() {
             document.getElementById('count-opd').textContent = patients.filter(p => p.type === 'opd').length;
             document.getElementById('count-ipd').textContent = patients.filter(p => p.type === 'ipd').length;
             document.getElementById('count-appointments').textContent = patients.filter(p => p.hasTodayVisit).length; 
             document.getElementById('count-waiting-results').textContent = patients.filter(p => isWaitingStatus(p.status)).length;
        }
        
        // --- 4. Triage/Search Logic (Unchanged) ---
        
        function filterPatients() {
            const query = document.getElementById('triage-search-input').value.toLowerCase().trim();
            const resultsContainer = document.getElementById('triagePatientResult');
            resultsContainer.innerHTML = '';

            if (query.length < 2) {
                resultsContainer.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 1rem;">กรุณาพิมพ์ HN, ชื่อ, ID Card หรือเบอร์โทร เพื่อเริ่มค้นหาข้อมูลผู้ป่วย</p>';
                return;
            }

            const filtered = patients.filter(p => 
                p.name.toLowerCase().includes(query) ||
                p.hn.toLowerCase().includes(query) ||
                (p.idCard && p.idCard.includes(query)) ||
                (p.tel && p.tel.includes(query))
            );
            
            // *** FIXED LOGIC: If no patient is found, show the 'Create New' prompt ***
            if (filtered.length === 0) {
                 resultsContainer.innerHTML = `
                    <p style="text-align: center; color: #ef4444; padding: 1rem;">ไม่พบผู้ป่วยที่ตรงกับ "${query}" ในระบบ</p>
                    <div style="text-align: center; margin-top: 1rem;">
                        <button onclick="showPage('page-register')" style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 0.5rem; font-size: 1rem; font-weight: 600; cursor: pointer;">
                             <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 0.5rem;"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
                             สร้างประวัติใหม่
                        </button>
                    </div>
                `;
                return;
            }

            let html = '';
            filtered.forEach(patient => {
                const visitBtn = patient.hasTodayVisit 
                    ? `<span class="status-badge" style="background:#007bff; color:white;">มี Visit วันนี้ (คลิกเพื่อดู Detail)</span>`
                    : `<button class="status-badge" style="background:#10b981; color:white; border:none; cursor:pointer;" onclick="showCreateVisitPage('${patient.hn}')">เปิด Visit ใหม่</button>`;
                
                // Use createPatientCard with triage mode for correct styling/behavior
                html += `
                    <div class="patient-card" onclick="${patient.hasTodayVisit ? `showPatientDetail('${patient.hn}')` : 'void(0)'}">
                        <div class="patient-card-header">
                            <div class="patient-info">
                                <div class="patient-avatar" style="background: ${patient.gender === 'M' ? '#3b82f6' : '#ec4899'};">${patient.name.charAt(0)}</div>
                                <div>
                                    <div class="patient-name">${patient.name} (${patient.age} ปี)</div>
                                    <div class="patient-id">HN: ${patient.hn} | Tel: ${patient.tel || '-'} | ID: ${patient.idCard}</div>
                                </div>
                            </div>
                            ${visitBtn}
                        </div>
                    </div>
                `;
            });

            resultsContainer.innerHTML = html;
        }

        function showCreateVisitPage(hn) {
            const patient = patients.find(p => p.hn === hn);
            if (!patient) return;
            
            const content = `
                <h3 style="color: #3b82f6;">ยืนยันการเปิด Visit ใหม่</h3>
                <div class="card" style="margin-top: 1rem; padding: 1rem;">
                    <p><strong>ชื่อผู้ป่วย:</strong> ${patient.name}</p>
                    <p><strong>HN:</strong> ${patient.hn}</p>
                    <p><strong>วันเกิด:</strong> ${patient.dob} (${patient.age} ปี)</p>
                    <p><strong>สถานะปัจจุบัน:</strong> ไม่มี Visit ในวันนี้</p>
                </div>
                
                <form style="display: grid; gap: 1rem; max-width: 600px;">
                    <label style="font-weight: 600;">เหตุผลการมา:</label>
                    <select id="visit-reason" style="padding: 0.75rem; border: 1px solid #ccc; border-radius: 0.5rem;" required>
                        <option value="">-- เลือกเหตุผล --</option>
                        <option value="OPD">ผู้ป่วยนอก (OPD)</option>
                        <option value="ER">ฉุกเฉิน (ER)</option>
                        <option value="Checkup">ตรวจสุขภาพประจำปี</option>
                    </select>
                    
                    <button type="button" onclick="confirmCreateVisit('${patient.hn}')" 
                            style="padding: 1rem; background: #10b981; color: white; border: none; border-radius: 0.5rem; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 1rem;">
                        ยืนยันการเปิด Visit และเริ่มกระบวนการคัดกรอง
                    </button>
                </form>
            `;
            document.getElementById('createVisitContent').innerHTML = content;
            showPage('page-create-visit');
        }

        function confirmCreateVisit(hn) {
            const patient = patients.find(p => p.hn === hn);
            if (!patient) return;
            
            // Mock: Simulate opening a new visit
            const newVN = `VN${Math.floor(Math.random() * 900) + 100}-2568`;
            patient.vn = newVN;
            patient.status = 'pending-screening';
            patient.hasTodayVisit = true;
            patient.concierge = 'สมใจ ใจดี';
            
            alert(`เปิด Visit ใหม่สำหรับ ${patient.name} สำเร็จ! VN: ${newVN}\nกำลังเข้าสู่หน้า Patient Detail...`);
            
            // Go to the detail page for the newly created visit
            showPatientDetail(hn);
        }
        
        // --- 5. DETAIL PAGE LOGIC (UPDATED) ---
        
        // Helper for Billing Status Color
        function getBillingStatusColor(status) {
            if (status.includes('รอชำระ')) return 'background: #dc3545; color: white;';
            if (status.includes('ชำระแล้ว')) return 'background: #28a745; color: white;';
            return 'background: #6c757d; color: white;';
        }

        // 5.1. Render Medication/RX Tab (NEW FUNCTION)
        function renderMedicationTab(patient) {
            const meds = patientMedication[patient.hn] || [];
            let html = '<h3 class="card-title">รายการยากลับบ้าน (RX)</h3>';

            if (meds.length === 0) {
                return html + '<p style="text-align: center; color: #6b7280; padding: 1rem;">ไม่พบรายการยาที่สั่งจ่ายใน Visit นี้</p>';
            }

            html += `
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 2fr 1fr; gap: 0.5rem; font-weight: bold; padding: 0.75rem 0.5rem; border-bottom: 2px solid #ccc; background: #f3f4f6; border-radius: 0.5rem 0.5rem 0 0;">
                    <div>รายการยา</div>
                    <div style="text-align: center;">จำนวน</div>
                    <div style="text-align: center;">หน่วย</div>
                    <div>คำแนะนำ</div>
                    <div style="text-align: center;">สถานะจัดยา</div>
                </div>
                <div style="font-size: 0.9rem;">
            `;

            meds.forEach(med => {
                const statusColor = med.status === 'จัดยาแล้ว' ? '#28a745' : '#f59e0b';
                html += `
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 2fr 1fr; gap: 0.5rem; padding: 0.75rem 0.5rem; border-bottom: 1px solid #eee; align-items: center;">
                        <div style="font-weight: 600;">${med.name}</div>
                        <div style="text-align: center;">${med.qty}</div>
                        <div style="text-align: center;">${med.unit}</div>
                        <div style="color: #6b7280;">${med.instruction}</div>
                        <div style="text-align: center;">
                            <span class="status-badge" style="background: ${statusColor}; color: white; padding: 0.3rem 0.6rem; border-radius: 0.5rem;">${med.status}</span>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            return html;
        }

        // 5.2. Render Visit History Tab (NEW FUNCTION)
        function renderHistoryTab(patient) {
            const visits = patientVisits[patient.hn] || [];
            let html = '<h3 class="card-title">ประวัติการมาโรงพยาบาล (Visit History)</h3>';

            if (visits.length === 0) {
                return html + '<p style="text-align: center; color: #6b7280; padding: 1rem;">ไม่พบประวัติการมาโรงพยาบาลย้อนหลัง</p>';
            }

            html += `
                <div style="display: grid; grid-template-columns: 1fr 1fr 2fr 1.5fr; gap: 0.5rem; font-weight: bold; padding: 0.75rem 0.5rem; border-bottom: 2px solid #ccc; background: #f3f4f6; border-radius: 0.5rem 0.5rem 0 0;">
                    <div>วันที่</div>
                    <div>VN</div>
                    <div>เหตุผล/อาการ</div>
                    <div>แพทย์ผู้ดูแล</div>
                </div>
                <div style="font-size: 0.9rem;">
            `;

            visits.forEach(visit => {
                html += `
                    <div class="patient-card" onclick="alert('จำลอง: เปิดรายละเอียด Visit ${visit.vn}')" style="margin-bottom: 0.5rem; cursor: pointer; padding: 0.75rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 2fr 1.5fr; gap: 0.5rem; align-items: center;">
                            <div>${visit.date}</div>
                            <div style="font-weight: 600; color: #3b82f6;">${visit.vn}</div>
                            <div style="color: #4b5563;">${visit.reason}</div>
                            <div>${visit.doctor}</div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            return html;
        }


        // 5.3. Render Billing/Charges Tab (NEW FUNCTION)
        function renderBillingTab(patient) {
            const bills = patientBilling[patient.hn] || [];
            let html = '<h3 class="card-title">บัญชี/ค่าใช้จ่าย</h3>';
            let totalDue = 0;

            if (bills.length === 0) {
                return html + '<p style="text-align: center; color: #6b7280; padding: 1rem;">ไม่พบรายการค่าใช้จ่าย</p>';
            }
            
            // Calculate total due
            bills.filter(b => b.status.includes('รอชำระ')).forEach(b => totalDue += b.amount);

            html += `
                <div style="margin-bottom: 1.5rem; padding: 1rem; background: ${totalDue > 0 ? '#fff0f0' : '#f0fff5'}; border: 2px solid ${totalDue > 0 ? '#dc3545' : '#10b981'}; border-radius: 0.75rem;">
                    <p style="font-size: 1.25rem; font-weight: bold; color: ${totalDue > 0 ? '#dc3545' : '#10b981'};">ยอดค้างชำระรวม: 
                        <span style="float: right;">${totalDue.toLocaleString('th-TH', { style: 'currency', currency: 'THB', minimumFractionDigits: 2 })}</span>
                    </p>
                    ${totalDue > 0 ? `<button onclick="openBilling(currentPatientData)" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: #dc3545; color: white; border: none; border-radius: 0.5rem; cursor: pointer;">
                        ดำเนินการชำระเงิน
                    </button>` : `<p style="margin-top: 0.5rem;">ผู้ป่วยได้ชำระค่าใช้จ่ายทั้งหมดเรียบร้อยแล้ว</p>`}
                </div>
                
                <h4 style="margin-bottom: 1rem; color: #4b5563;">รายการค่าใช้จ่ายทั้งหมด:</h4>

                <div style="display: grid; grid-template-columns: 1fr 3fr 1fr 1.5fr; gap: 0.5rem; font-weight: bold; padding: 0.75rem 0.5rem; border-bottom: 2px solid #ccc; background: #f3f4f6; border-radius: 0.5rem 0.5rem 0 0;">
                    <div>วันที่</div>
                    <div>รายการ</div>
                    <div style="text-align: right;">จำนวนเงิน</div>
                    <div style="text-align: center;">สถานะ</div>
                </div>
                <div style="font-size: 0.9rem;">
            `;

            bills.forEach(bill => {
                const statusStyle = getBillingStatusColor(bill.status);
                html += `
                    <div style="display: grid; grid-template-columns: 1fr 3fr 1fr 1.5fr; gap: 0.5rem; padding: 0.75rem 0.5rem; border-bottom: 1px solid #eee; align-items: center;">
                        <div>${bill.date}</div>
                        <div>${bill.description}</div>
                        <div style="text-align: right; font-weight: 600;">${bill.amount.toLocaleString('th-TH', { minimumFractionDigits: 2 })}</div>
                        <div style="text-align: center;">
                            <span class="status-badge" style="${statusStyle}">${bill.status}</span>
                        </div>
                    </div>
                `;
            });
			

            html += '</div>';
            return html;
			
			// Render Services/Lab Tab
function renderServiceTab(patient) {
    const services = patientServices[patient.hn] || [];
    let html = '<h3 class="card-title">Services/Investigate</h3>';

    if (services.length === 0) {
        return html + '<p style="text-align: center; color: #6b7280; padding: 1rem;">ไม่พบรายการตรวจใน Visit นี้</p>';
    }

    html += `
        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 2fr; gap: 0.5rem; font-weight: bold; padding: 0.75rem 0.5rem; border-bottom: 2px solid #ccc; background: #f3f4f6; border-radius: 0.5rem 0.5rem 0 0;">
            <div>รายการตรวจ</div>
            <div style="text-align: center;">วันที่</div>
            <div style="text-align: center;">สถานะ</div>
            <div>ผลตรวจ</div>
        </div>
        <div style="font-size: 0.9rem;">
    `;

    services.forEach(item => {
        const badgeColor = item.status.includes('รอ') ? '#f59e0b' : '#10b981'; // เหลือง/เขียว
        html += `
            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 2fr; gap: 0.5rem; padding: 0.75rem 0.5rem; border-bottom: 1px solid #eee; align-items: center;">
                <div style="font-weight: 600;">${item.name}</div>
                <div style="text-align: center;">${item.date}</div>
                <div style="text-align: center;">
                    <span class="status-badge" style="background: ${badgeColor}; color: white; padding: 0.3rem 0.6rem; border-radius: 0.5rem;">${item.status}</span>
                </div>
                <div style="color: #4b5563;">${item.result}</div>
            </div>
        `;
    });

    html += '</div>';
    return html;
}

        }

        /**
         * Loads and displays the patient detail page.
         */
        function showPatientDetail(hn) {
            const patient = patients.find(p => p.hn === hn);
            if (!patient) {
                alert('ไม่พบข้อมูลผู้ป่วย HN: ' + hn);
                return;
            }
            
            currentPatientData = patient; // Set global data
            
            // 1. Update Detail Header
            document.getElementById('detailName').textContent = patient.name;
            document.getElementById('detailHN').textContent = `HN: ${patient.hn} | VN: ${patient.vn || '-'}`;
            document.getElementById('detailConcierge').textContent = `Concierge: ${patient.concierge || 'ไม่ระบุ'}`;
            
            const detailStatusEl = document.getElementById('detailStatus');
            detailStatusEl.textContent = getStatusText(patient.status);
            detailStatusEl.style = getStatusColor(patient.status) + 'font-size: 1rem; padding: 0.5rem 1rem;';
            
            // 2. Update Basic Info
            document.getElementById('detailAge').textContent = patient.age;
            document.getElementById('detailGender').textContent = patient.gender === 'M' ? 'ชาย' : patient.gender === 'F' ? 'หญิง' : '-';
            document.getElementById('detailDOB').textContent = patient.dob;
            
            // 3. Update Avatar
            const avatarEl = document.getElementById('detailAvatar');
            avatarEl.textContent = patient.name.charAt(0);
            avatarEl.style.background = patient.gender === 'M' ? '#3b82f6' : '#ec4899';
            
            // 4. Update Timeline
            updateTimeline(patient.status);
            
            // 5. Render Tab Content (NEW)
            document.getElementById('medication-tab').innerHTML = renderMedicationTab(patient);
            document.getElementById('history-tab').innerHTML = renderHistoryTab(patient);
            document.getElementById('billing-tab').innerHTML = renderBillingTab(patient);

            // 6. Switch Page
            showPage('page-patient-detail');
            
            // 7. Set default tab to Timeline
            showDetailTab('timeline-tab', document.querySelector('#page-patient-detail .detail-tabs .tab-item:first-child'));
        }

        /**
         * Renders the patient journey timeline based on the current status.
         */
        function updateTimeline(currentStatus) {
            const statusOrder = [
                { id: 'pending-screening', text: 'ลงทะเบียน/รอคัดกรอง', icon: 'file-text' },
                { id: 'waiting-doctor', text: 'คัดกรองเสร็จสิ้น/รอพบแพทย์', icon: 'stethoscope' },
                { id: 'in-treatment', text: 'พบแพทย์/รักษา', icon: 'user-plus' },
                { id: 'waiting-lab', text: 'รอผล Lab/X-Ray', icon: 'flask-conical' },
                { id: 'waiting-service', text: 'รอรับบริการอื่นๆ', icon: 'sun' },
                { id: 'waiting-medication', text: 'รอจ่ายยา', icon: 'pill' },
                { id: 'waiting-billing', text: 'รอจ่ายเงิน', icon: 'credit-card' },
                { id: 'finished', text: 'เสร็จสิ้น/จำหน่าย', icon: 'check-circle' }
            ];

            let currentStatusFound = false;
            let html = '';

            statusOrder.forEach(item => {
                let isCompleted = currentStatusFound;
                let isActive = item.id === currentStatus;
                
                if (isActive) {
                    currentStatusFound = true; 
                } else if (currentStatusFound === false && item.id !== 'finished' && item.id !== 'ipd-admitted') {
                    isCompleted = true; 
                }

                const statusClass = isActive ? 'active' : isCompleted ? 'completed' : '';
                
                // Simplified SVG paths for demonstration
                const iconMap = {
                    'file-text': '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M10 12H8"/><path d="M16 12H12"/>',
                    'stethoscope': '<path d="M18 10a6 6 0 1 0-12 0v5h12v-5zM12 16v4M8 20h8M12 2v2M6 6l2 2M18 6l-2 2"/>',
                    'user-plus': '<path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><path d="M20 8v6M23 11h-6"/>',
                    'flask-conical': '<path d="M10 2v6a2 2 0 0 0 2 2h0a2 2 0 0 0 2-2V2M14 10v10a2 2 0 0 1-2 2h0a2 2 0 0 1-2-2V10M8 22h8"/>',
                    'sun': '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>',
                    'pill': '<path d="M18 2a3 3 0 0 0-3 3v2a2 2 0 0 0-2 2v1h-2V9a2 2 0 0 0-2-2V5a3 3 0 0 0-3-3H6a3 3 0 0 0-3 3v2a2 2 0 0 0 2 2v1h2v2H5a2 2 0 0 0-2 2v2a3 3 0 0 0 3 3h4a3 3 0 0 0 3-3v-2a2 2 0 0 0 2-2v-1h2v2a2 2 0 0 0 2 2v2a3 3 0 0 0 3 3h4a3 3 0 0 0 3-3v-2a2 2 0 0 0-2-2h-2v-1a2 2 0 0 0 2-2V5a3 3 0 0 0-3-3h-4z"/>', // Changed to a simpler cross
                    'credit-card': '<rect width="20" height="14" x="2" y="5" rx="2"/><path d="M2 10h20"/><path d="M16 16h2"/><path d="M14 16h-4"/>',
                    'check-circle': '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>'
                };
                const iconSVG = `<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${iconMap[item.icon]}</svg>`;


                html += `
                    <div class="timeline-item ${statusClass}">
                        <div class="timeline-marker">
                            <div class="timeline-icon">${iconSVG}</div>
                        </div>
                        <div class="timeline-content">
                            <span class="timeline-badge">${isActive ? 'ปัจจุบัน' : isCompleted ? 'เสร็จสิ้น' : 'รอการดำเนินการ'}</span>
                            <h4>${item.text}</h4>
                            <p>${isActive ? 'กำลังอยู่ในขั้นตอนนี้นับตั้งแต่ 10:30 น.' : isCompleted ? 'ดำเนินการเสร็จสิ้นเมื่อ 09:45 น.' : 'ยังไม่ถึงขั้นตอน'}</p>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('patientTimeline').innerHTML = html;
        }

        /**
         * Handles switching between tabs in the patient detail view.
         */
        function showDetailTab(tabId, element) {
            document.querySelectorAll('.detail-tab-content').forEach(content => content.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');

            document.querySelectorAll('.detail-tabs .tab-item').forEach(item => item.classList.remove('active'));
            element.classList.add('active');
        }

        // --- 6. Schedule Logic (Unchanged) ---

        function populateDoctorSelect() {
            const selectEl = document.getElementById('doctor-select');
            if (selectEl.options.length > 1) return; // Prevent duplicate population

            doctors.forEach(doc => {
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = `${doc.name} (${doc.speciality})`;
                selectEl.appendChild(option);
            });
        }

        function loadDoctorSchedule(doctorId) {
            const container = document.getElementById('doctor-schedule-calendar');
            const doctor = doctors.find(d => d.id === doctorId);
            document.getElementById('schedule-doctor-name').textContent = doctor ? doctor.name : '';

            if (!doctorId || !doctorSchedules[doctorId]) {
                container.innerHTML = `<p style="text-align: center; color: #6b7280; padding: 2rem;">กรุณาเลือกแพทย์เพื่อแสดงตารางการตรวจ</p>`;
                return;
            }

            const schedule = doctorSchedules[doctorId];
            let html = `
                <div class="schedule-grid-header">
                    <div>วัน</div>
                    <div>เวลา</div>
                    <div>ห้องตรวจ</div>
                    <div>สถานะ</div>
                    <div>หมายเหตุ</div>
                </div>
            `;

            const dayOrder = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const thaiDays = { 'Mon': 'จันทร์', 'Tue': 'อังคาร', 'Wed': 'พุธ', 'Thu': 'พฤหัสบดี', 'Fri': 'ศุกร์', 'Sat': 'เสาร์', 'Sun': 'อาทิตย์' };

            dayOrder.forEach(day => {
                const daySchedule = schedule.filter(s => s.day === day);
                if (daySchedule.length > 0) {
                    daySchedule.forEach(item => {
                        const statusColor = item.status === 'Open' ? 'color: #10b981; font-weight: bold;' : 'color: #dc3545;';
                        html += `
                            <div class="schedule-grid-row">
                                <div>${thaiDays[item.day]}</div>
                                <div>${item.time}</div>
                                <div>${item.room}</div>
                                <div style="${statusColor}">${item.status}</div>
                                <div>-</div>
                            </div>
                        `;
                    });
                } else {
                     html += `
                        <div class="schedule-grid-row" style="color:#a1a1aa;">
                            <div>${thaiDays[day]}</div>
                            <div colspan="4">ไม่มีตารางตรวจ</div>
                        </div>
                    `;
                }
            });

            container.innerHTML = html;
        }

        
        // --- 7. APPOINTMENTS PAGE LOGIC (Unchanged) ---

        function initializeAppointmentsPage() {
            renderAppointmentCalendar(currentCalendarYear, currentCalendarMonth);
            // Default to showing today's appointments
            renderDailyAppointments(todayDate);
        }

        /**
         * Renders the calendar for the given year and month.
         */
        function renderAppointmentCalendar(year, month) {
            const calendarEl = document.getElementById('appointmentCalendar');
            const date = new Date(year, month, 1);
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            currentCalendarYear = year;
            currentCalendarMonth = month;

            const monthNames = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
            const dayNames = ["อา", "จ", "อ", "พ", "พฤ", "ศ", "ส"];

            // --- Header ---
            let html = `
                <div class="calendar-header">
                    <button onclick="changeMonth(-1)" style="background:none; border:none; cursor:pointer; color:#3b82f6;">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg>
                    </button>
                    <span>${monthNames[month]} ${year}</span>
                    <button onclick="changeMonth(1)" style="background:none; border:none; cursor:pointer; color:#3b82f6;">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
                    </button>
                </div>
                <div class="calendar-grid">
            `;

            // Day Names
            dayNames.forEach(day => {
                html += `<div class="calendar-day-name">${day}</div>`;
            });

            // Days padding (empty cells before the 1st day)
            const firstDayOfWeek = date.getDay(); // 0 = Sunday
            for (let i = 0; i < firstDayOfWeek; i++) {
                html += `<div class="calendar-day inactive"></div>`;
            }

            // Days of the month
            let day = 1;
            while (date.getMonth() === month) {
                const dateStr = date.toISOString().split('T')[0];
                const appointments = getAppointmentsByDate(dateStr);
                const count = appointments.length;
                
                let dayClass = '';
                if (dateStr === todayStr) dayClass += ' today';
                if (count > 0) dayClass += ' has-appointment';

                html += `
                    <div class="calendar-day${dayClass}" 
                         data-date="${dateStr}" 
                         onclick="renderDailyAppointments('${dateStr}', this)">
                        <span class="calendar-day-date">${day}</span>
                        ${count > 0 ? `<span class="calendar-appointment-count">${count} นัด</span>` : ''}
                    </div>
                `;

                date.setDate(date.getDate() + 1);
                day++;
            }
            
            // Days padding (empty cells after the last day)
            const lastDayOfWeek = new Date(year, month + 1, 0).getDay();
            for (let i = lastDayOfWeek; i < 6; i++) {
                 html += `<div class="calendar-day inactive"></div>`;
            }

            html += `</div>`;
            calendarEl.innerHTML = html;
            
            // Re-select the currently shown date if it exists in the new month
            const selectedDateEl = document.querySelector(`.calendar-day[data-date="${document.getElementById('dailyAppointmentsContainer').getAttribute('data-selected-date')}"]`);
            if (selectedDateEl) {
                 selectedDateEl.classList.add('selected');
            } else {
                 // If changing month, set today as selected by default in the new view
                 document.querySelector('.calendar-day.today')?.classList.add('selected');
            }
        }
        
        /**
         * Changes the month displayed in the calendar.
         */
        function changeMonth(direction) {
            const newDate = new Date(currentCalendarYear, currentCalendarMonth + direction, 1);
            renderAppointmentCalendar(newDate.getFullYear(), newDate.getMonth());
        }

        /**
         * Finds appointments for a specific date string (YYYY-MM-DD).
         */
        function getAppointmentsByDate(dateStr) {
            return allAppointments.filter(app => app.date === dateStr).sort((a, b) => a.time.localeCompare(b.time));
        }

        /**
         * Renders the list of appointments for the selected day.
         */
        function renderDailyAppointments(dateStr, element) {
            const container = document.getElementById('dailyAppointmentsContainer');
            const appointments = getAppointmentsByDate(dateStr);
            
            // Clear previous selection and mark current day as selected
            document.querySelectorAll('.calendar-day').forEach(day => day.classList.remove('selected'));
            if (element) {
                 element.classList.add('selected');
            } else {
                 // For initial load, try to find today's element
                 document.querySelector(`.calendar-day[data-date="${dateStr}"]`)?.classList.add('selected');
            }
            
            // Update selected date text
            const dateParts = dateStr.split('-');
            const thaiDate = `${parseInt(dateParts[2])} ${getThaiMonth(parseInt(dateParts[1]))} ${parseInt(dateParts[0]) + 543}`;
            document.getElementById('selectedDateText').textContent = thaiDate;
            container.setAttribute('data-selected-date', dateStr);

            if (appointments.length === 0) {
                container.innerHTML = `<p style="text-align: center; color: #6b7280; padding: 1rem;">ไม่พบรายการนัดในวันที่ ${thaiDate}</p>`;
                return;
            }

            let html = '';
            appointments.forEach(app => {
                // Card click navigates to showEditAppointmentPage
                html += `
                    <div class="appointment-result-card" onclick="showEditAppointmentPage('${app.hn}', '${app.date}', '${app.time}')" style="border-left: 5px solid ${app.status === 'Active' ? '#3b82f6' : '#10b981'};">
                        <p><span>${app.time} น.</span> | HN: ${app.hn}</p>
                        <p><span>${app.name}</span></p>
                        <p>แพทย์: ${app.doctor} (${app.speciality})</p>
                        <p style="font-style: italic; color: ${app.status === 'Active' ? '#3b82f6' : '#10b981'};">สถานะ: ${app.status === 'Active' ? 'Visit วันนี้' : 'รอนัด'}</p>
                    </div>
                `;
            });

            container.innerHTML = html;
        }
        
        /**
         * Searches for a patient and displays all their future appointments.
         */
        function filterAppointmentsByPatient() {
            const query = document.getElementById('appointment-search-input').value.toLowerCase().trim();
            const resultsContainer = document.getElementById('appointmentSearchResult');
            resultsContainer.innerHTML = '';

            if (query.length < 2) {
                resultsContainer.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 1rem;">พิมพ์เพื่อค้นหารายการนัดของผู้ป่วย</p>';
                return;
            }

            const matchedPatients = patients.filter(p => 
                p.name.toLowerCase().includes(query) ||
                p.hn.toLowerCase().includes(query) ||
                (p.idCard && p.idCard.includes(query)) ||
                (p.tel && p.tel.includes(query))
            );

            // If patient not found in the master list
            if (matchedPatients.length === 0) {
                resultsContainer.innerHTML = `
                    <p style="text-align: center; color: #ef4444; padding: 1rem;">ไม่พบผู้ป่วยที่ตรงกับ "${query}" ในระบบ</p>
                    <div style="text-align: center; margin-top: 1rem;">
                        <button onclick="showPage('page-register')" style="padding: 0.75rem 1.5rem; background: #dc3545; color: white; border: none; border-radius: 0.5rem; font-size: 1rem; font-weight: 600; cursor: pointer;">
                             <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 0.5rem;"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
                             ลงทะเบียนผู้ป่วยใหม่/ทำนัด (Walk-in)
                        </button>
                    </div>
                `;
                return;
            }

            let html = '';
            let foundAppointments = 0;
            const patient = matchedPatients[0]; // Assume first match is the target

            const patientAppointments = allAppointments.filter(app => app.hn === patient.hn);
                
            if (patientAppointments.length > 0) {
                foundAppointments += patientAppointments.length;
                
                html += `<h4 style="margin-top: 1rem; color: #3b82f6;">${patient.name} (HN: ${patient.hn}) มี ${patientAppointments.length} นัด:</h4>`;
                
                patientAppointments.forEach(app => {
                    const dateParts = app.date.split('-');
                    const thaiDate = `${parseInt(dateParts[2])} ${getThaiMonth(parseInt(dateParts[1]))} ${parseInt(dateParts[0]) + 543}`;
                    
                    // Card click navigates to showEditAppointmentPage
                    html += `
                         <div class="appointment-result-card" onclick="showEditAppointmentPage('${app.hn}', '${app.date}', '${app.time}')" style="border-left: 5px solid #10b981;">
                            <p><span>วันที่: ${thaiDate}</span> | <span>เวลา: ${app.time} น.</span></p>
                            <p>แพทย์: ${app.doctor} (${app.speciality})</p>
                            <p style="font-style: italic; color: #6b7280;">สถานะ: ${app.status}</p>
                        </div>
                    `;
                });
            }
            
            // If patient found but no appointments, show the 'Create New Appointment' button
            if (foundAppointments === 0) {
                 resultsContainer.innerHTML = `
                    <p style="text-align: center; color: #6b7280; padding: 1rem;">พบผู้ป่วย **${patient.name}** (HN: ${patient.hn}) **แต่ไม่พบ** รายการนัด</p>
                    <div style="text-align: center; margin-top: 1rem;">
                        <button onclick="alert('จำลอง: เริ่มสร้างนัดใหม่สำหรับ ${patient.name}')" style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 0.5rem; font-size: 1rem; font-weight: 600; cursor: pointer;">
                            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 0.5rem;"><path d="M15 3h6v6"/><path d="M10 14V2m0 0 5 5m-5-5-5 5"/><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/></svg>
                            สร้างนัดใหม่สำหรับ ${patient.name}
                        </button>
                    </div>
                `;
            } else {
                resultsContainer.innerHTML = html;
            }
        }
        
        function getThaiMonth(monthIndex) {
            const thaiMonths = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
            return thaiMonths[monthIndex - 1];
        }

        // --- 8. NEW FUNCTION: Show Edit Appointment Page (Unchanged) ---
        function showEditAppointmentPage(hn, date, time) {
            const patient = patients.find(p => p.hn === hn);
            const appointment = allAppointments.find(app => app.hn === hn && app.date === date && app.time === time);

            if (!patient || !appointment) {
                alert('ไม่พบข้อมูลผู้ป่วยหรือรายการนัด');
                return;
            }

            const thaiDate = `${parseInt(appointment.date.split('-')[2])} ${getThaiMonth(parseInt(appointment.date.split('-')[1]))} ${parseInt(appointment.date.split('-')[0]) + 543}`;
            
            const content = `
                <button class="menu-item" style="width: auto;" onclick="showPage('page-appointments')">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg> กลับหน้ารายการนัด
                </button>
                <h2 class="card-title">แก้ไขรายการนัด</h2>
                <div class="card">
                    <h3 style="color: #3b82f6;">ข้อมูลผู้ป่วย: ${patient.name} (HN: ${patient.hn})</h3>
                    <div style="padding: 1rem; border: 1px solid #eee; border-radius: 0.5rem; margin-bottom: 1.5rem; background: #f9fafb;">
                        <p><strong>แพทย์ปัจจุบัน:</strong> ${appointment.doctor} (${appointment.speciality})</p>
                        <p><strong>วันที่นัด:</strong> ${thaiDate}</p>
                        <p><strong>เวลานัด:</strong> ${appointment.time} น.</p>
                        <p><strong>สถานะนัด:</strong> <span style="font-weight: bold; color: ${appointment.status === 'Active' ? '#3b82f6' : '#10b981'};">${appointment.status}</span></p>
                    </div>
                    
                    <form style="display: grid; gap: 1rem; max-width: 600px;">
                        <p style="font-weight: 600; border-bottom: 1px solid #eee; padding-bottom: 0.5rem;">แบบฟอร์มแก้ไข/ยกเลิกนัด</p>

                        <div style="display: grid; gap: 0.5rem;">
                            <label for="edit-doctor" style="font-weight: 600;">แพทย์ที่ต้องการเปลี่ยน:</label>
                            <select id="edit-doctor" style="padding: 0.75rem; border: 1px solid #ccc; border-radius: 0.5rem;">
                                <option value="${appointment.doctor}">${appointment.doctor} (ปัจจุบัน)</option>
                                <option value="D001">นพ. วิทยา เก่งกาจ</option>
                                <option value="D002">พญ. สุดา น่ารัก</option>
                                <option value="D003">นพ. ทรงพล มือแม่น</option>
                            </select>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div style="display: grid; gap: 0.5rem;">
                                <label for="edit-date" style="font-weight: 600;">เปลี่ยนวันที่:</label>
                                <input type="date" id="edit-date" value="${date}" style="padding: 0.75rem; border: 1px solid #ccc; border-radius: 0.5rem;">
                            </div>
                            <div style="display: grid; gap: 0.5rem;">
                                <label for="edit-time" style="font-weight: 600;">เปลี่ยนเวลา:</label>
                                <input type="time" id="edit-time" value="${time}" style="padding: 0.75rem; border: 1px solid #ccc; border-radius: 0.5rem;">
                            </div>
                        </div>
                        
                        <button type="button" onclick="alert('จำลอง: บันทึกการแก้ไขนัดเรียบร้อยแล้ว')" 
                                style="padding: 1rem; background: #3b82f6; color: white; border: none; border-radius: 0.5rem; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 1rem;">
                            บันทึกการแก้ไขรายการนัด
                        </button>
                        <button type="button" onclick="alert('จำลอง: ยกเลิกรายการนัดเรียบร้อยแล้ว')" 
                                style="padding: 1rem; background: #dc3545; color: white; border: none; border-radius: 0.5rem; font-size: 1rem; font-weight: 600; cursor: pointer;">
                            ยกเลิกรายการนัด
                        </button>
                    </form>
                </div>
            `;
            document.getElementById('editAppointmentContent').innerHTML = content;
            showPage('page-edit-appointment');
        }


        // --- 9. UTILITY & EVENT HANDLERS (Unchanged) ---
        
        function toggleSidebar(forceClose = false) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (forceClose || sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                overlay.style.display = 'none';
            } else {
                sidebar.classList.add('open');
                overlay.style.display = 'block';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            updateDashboardCounts();
            showPage('page-home'); // This will automatically trigger filterPatientsByCard('opd', ...)
        });
        
        // Placeholder functions for toolbar buttons
        function openPatientRegistration(patient) { alert(`เริ่มกระบวนการ: เปิด Visit สำหรับ ${patient.name || 'ผู้ป่วยใหม่'}`); if (!patient) showPage('page-register'); }
        function openScreening(patient) { alert(`เริ่มกระบวนการ: คัดกรองสำหรับ ${patient.name}`); }
        function openAssessment(patient) { alert(`เริ่มกระบวนการ: ประเมินสำหรับ ${patient.name}`); }
        function assignDoctor(patient) { alert(`เริ่มกระบวนการ: กำหนดแพทย์สำหรับ ${patient.name}`); }
        function createAppointment(patient) { alert(`เริ่มกระบวนการ: ทำนัดสำหรับ ${patient.name}`); }
        function openHomeMed(patient) { alert(`${patient.name} Pt.มี  HomeMedมาจากที่บ้าน `); }
        function openBilling(patient) { alert(`เริ่มกระบวนการ: แจ้งค่าใช้จ่าย/Billing สำหรับ ${patient.name}`); }
        function pickUpMedicine(patient) { alert(`เริ่มกระบวนการ: รับยาแทนสำหรับ ${patient.name}`); }
        function openOther(patient) { alert(`เริ่มกระบวนการ: จัดการอื่นๆ สำหรับ ${patient.name}`); }
        
    </script>
</body>
</html>